@echo off

:: Color codes for output
setlocal enabledelayedexpansion

:RED
color 31
goto :EOF

:GREEN
color 32
goto :EOF

:YELLOW
color 33
goto :EOF

:NC
color 0
goto :EOF

:: Detect operating system
if "%OS%" == "Darwin" (
    set OS=macOS
) else if "%OS%" == "Linux" (
    set OS=Linux
) else if "%OS%" == "MINGW*" || "%OS%" == "MSYS*" || "%OS%" == "CYGWIN*" (
    set OS=Windows
) else (
    set OS=Unknown
)

:: Check if Python is installed
if exist %PROGRAMFILES%\Python\python3.8\python.exe (
    set PYTHON_CMD=python3.8
) else if exist %PROGRAMFILES%\Python\python\python.exe (
    set PYTHON_CMD=python
) else (
    echo Error: Python is not installed!
    echo Please install Python 3.8+ before proceeding.
    exit /b 1
)

:: Verify Python version
for /f "tokens=*" %%a in ('%PYTHON_CMD% -c "import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")"') do set PYTHON_VERSION=%%a

set MAJOR=%PYTHON_VERSION:~0,1%
set MINOR=%PYTHON_VERSION:~3,1%

if %MAJOR% lss 3 (
    echo Error: Python 3.8+ is required.
    echo Current version: %PYTHON_VERSION%
    exit /b 1
) else if %MAJOR% eq 3 and %MINOR% lss 8 (
    echo Error: Python 3.8+ is required.
    echo Current version: %PYTHON_VERSION%
    exit /b 1
)

:: Install uv package manager
echo Installing uv package manager...
if exist "%PROGRAMFILES%\Python\python3.8\Scripts\pip.exe" (
    call :install_uv_pip
) else if exist "%PROGRAMFILES%\Python\python\Scripts\pip.exe" (
    call :install_uv_pip3
) else (
    echo Installing pip using Python's built-in method...
    %PYTHON_CMD% -m ensurepip --upgrade
    %PYTHON_CMD% -m pip install uv
)

:: Verify uv installation
if not exist "%PROGRAMFILES%\Python\python3.8\Scripts\uv.exe" (
    echo Failed to install uv package manager!
    exit /b 1
)

echo Installation complete!
echo You can now run the watcher script directly using:
echo uv run watcher.py

exit /b 0

:: Install pip if necessary
:install_uv_pip
if exist "%PROGRAMFILES%\Python\python3.8\Scripts\pip.exe" (
    exit /b 0
) else if exist "%PROGRAMFILES%\Python\python\Scripts\pip3.exe" (
    exit /b 0
) else (
    %PYTHON_CMD% -m ensurepip --upgrade
)

:: Install pip3 if necessary
:install_uv_pip3
if exist "%PROGRAMFILES%\Python\python3.8\Scripts\pip3.exe" (
    exit /b 0
) else if exist "%PROGRAMFILES%\Python\python\Scripts\pip3.exe" (
    exit /b 0
) else (
    %PYTHON_CMD% -m ensurepip --upgrade
)

:: Verify pip installation
if not exist "%PROGRAMFILES%\Python\python3.8\Scripts\pip.exe" (
    echo Failed to install pip!
    exit /b 1
)